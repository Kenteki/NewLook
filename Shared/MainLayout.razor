@using Microsoft.AspNetCore.Components.Authorization
@using NewLook.Services
@using NewLook.Services.Interfaces
@using Microsoft.AspNetCore.Components.Web
@using BlazorBootstrap
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IUserService UserService
@implements IDisposable

<div class="page">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <strong>ðŸ“¦ NewLook</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link @(IsActive("/") ? "active" : "")" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(IsActive("/inventories") ? "active" : "")" href="/inventories">Inventories</a>
                    </li>
                </ul>

                <!-- Search Bar -->
                <div class="d-flex me-3">
                    <input class="form-control form-control-search me-2" type="search" placeholder="Search inventories..."
                           @bind="searchQuery" @bind:event="oninput" @onkeypress="HandleSearchKeyPress" />
                    <button class="btn btn-outline-light" type="button" @onclick="HandleSearch">
                        <i class="bi bi-search"></i>
                    </button>
                </div>

                <!-- Theme Switcher -->
                <div class="me-3">
                    <ThemeSwitcher />
                </div>

                <ul class="navbar-nav ms-auto">
                    <AuthorizeView>
                        <Authorized>
                            <li class="nav-item">
                                <a class="nav-link @(IsActive("/dashboard") ? "active" : "")" href="/dashboard">Dashboard</a>
                            </li>
                            @if (isUserAdmin)
                            {
                                <li class="nav-item">
                                    <a class="nav-link @(IsActive("/admin") ? "active" : "")" href="/admin">
                                        <i class="bi bi-shield-lock"></i> Admin
                                    </a>
                                </li>
                            }
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    ðŸ‘¤ @context.User.Identity?.Name
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="/inventories/create">âž• Create Inventory</a></li>
                                    <li><a class="dropdown-item" href="/dashboard">ðŸ“Š My Dashboard</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/logout">ðŸšª Logout</a></li>
                                </ul>
                            </li>
                        </Authorized>
                        <NotAuthorized>
                            <li class="nav-item">
                                <a class="nav-link" href="/login">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link btn btn-outline-light btn-sm ms-2" href="/register">Register</a>
                            </li>
                        </NotAuthorized>
                    </AuthorizeView>
                </ul>
            </div>
        </div>
    </nav>

    <main class="content py-4">
        @Body
    </main>

    <footer class="footer mt-auto py-3 bg-light border-top">
        <div class="container text-center">
            <span class="text-muted">NewLook Inventory Management Â© 2024 | Built with Blazor & .NET</span>
        </div>
    </footer>
</div>

@code {
    private string searchQuery = "";
    private bool isUserAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await CheckAdminStatus();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await CheckAdminStatus();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CheckAdminStatus()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);

            if (userIdClaim != null)
            {
                var userId = int.Parse(userIdClaim.Value);
                isUserAdmin = await UserService.IsUserAdminAsync(userId);
            }
            else
            {
                isUserAdmin = false;
            }
        }
        catch
        {
            isUserAdmin = false;
        }
    }

    private void HandleSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private void HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            HandleSearch();
        }
    }

    private bool IsActive(string path)
    {
        return Navigation.Uri.EndsWith(path, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}