@page "/inventories/{Id:int}"
@inject HttpClient Http
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@inventory?.Title - NewLook</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (inventory == null)
    {
        <div class="alert alert-danger">Inventory not found</div>
    }
    else
    {
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    @if (!string.IsNullOrEmpty(inventory.ImageUrl))
                    {
                        <img src="@inventory.ImageUrl" alt="@inventory.Title" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" class="me-3" />
                    }
                    <div>
                        <h2 class="mb-1">@inventory.Title</h2>
                        <p class="text-muted mb-0">
                            by @inventory.CreatorUsername
                            @if (!string.IsNullOrEmpty(inventory.CategoryName))
                            {
                                <span class="badge bg-secondary ms-2">@inventory.CategoryName</span>
                            }
                            @if (inventory.IsPublic)
                            {
                                <span class="badge bg-success ms-2">Public</span>
                            }
                        </p>
                        @if (inventory.Tags.Any())
                        {
                            <div class="mt-2">
                                @foreach (var tag in inventory.Tags)
                                {
                                    <span class="badge bg-light text-dark me-1">@tag</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                @if (inventory.HasWriteAccess)
                {
                    <a href="/inventories/edit/@Id" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <button class="btn btn-outline-danger ms-2" @onclick="DeleteInventory">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                }
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(activeTab == "items" ? "active" : "")" @onclick='() => SetActiveTab("items")'>
                    Items (@items.Count)
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "settings" ? "active" : "")" @onclick='() => SetActiveTab("settings")'>
                    Settings
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "access" ? "active" : "")" @onclick='() => SetActiveTab("access")'>
                    Access
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "customid" ? "active" : "")" @onclick='() => SetActiveTab("customid")'>
                    Custom ID
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "stats" ? "active" : "")" @onclick='() => SetActiveTab("stats")'>
                    Statistics
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        @if (activeTab == "items")
        {
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Items</h5>
                    @if (inventory.HasWriteAccess)
                    {
                        <a href="/inventories/@Id/items/create" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus"></i> Add Item
                        </a>
                    }
                </div>
                <div class="card-body">
                    @if (!items.Any())
                    {
                        <p class="text-muted text-center py-5">No items yet. Add your first item!</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Custom ID</th>
                                        @foreach (var field in inventory.CustomFields.Where(f => f.ShowInTable))
                                        {
                                            <th>@field.Name</th>
                                        }
                                        <th>Created By</th>
                                        <th>Likes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in items)
                                    {
                                        <tr>
                                            <td><strong>@item.CustomId</strong></td>
                                            @foreach (var field in inventory.CustomFields.Where(f => f.ShowInTable))
                                            {
                                                <td>@GetItemFieldValue(item, field)</td>
                                            }
                                            <td>@item.CreatedByUsername</td>
                                            <td>
                                                <button class="btn btn-sm @(item.IsLikedByCurrentUser ? "btn-danger" : "btn-outline-danger")"
                                                        @onclick="() => ToggleLike(item.Id)" disabled="@(!isAuthenticated)">
                                                    <i class="bi bi-heart@(item.IsLikedByCurrentUser ? "-fill" : "")"></i> @item.LikeCount
                                                </button>
                                            </td>
                                            <td>
                                                <a href="/inventories/@Id/items/@item.Id" class="btn btn-sm btn-outline-primary">View</a>
                                                @if (inventory.HasWriteAccess)
                                                {
                                                    <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteItem(item.Id)">Delete</button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        }
        else if (activeTab == "settings")
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">General Settings</h5>
                    <div class="mb-3">
                        <label class="fw-bold">Title:</label>
                        <p>@inventory.Title</p>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Description:</label>
                        <div>@((MarkupString)MarkdownToHtml(inventory.Description))</div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Category:</label>
                        <p>@(inventory.CategoryName ?? "None")</p>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Visibility:</label>
                        <p>@(inventory.IsPublic ? "Public (anyone can add items)" : "Private (only invited users)")</p>
                    </div>

                    <h5 class="mb-3 mt-4">Custom Fields</h5>
                    @if (inventory.CustomFields.Any())
                    {
                        <div class="list-group">
                            @foreach (var field in inventory.CustomFields)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>@field.Name</strong>
                                            <span class="badge bg-info ms-2">@field.FieldType</span>
                                            @if (field.ShowInTable)
                                            {
                                                <span class="badge bg-success ms-1">Shown in table</span>
                                            }
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(field.Description))
                                    {
                                        <small class="text-muted">@field.Description</small>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No custom fields defined</p>
                    }
                </div>
            </div>
        }
        else if (activeTab == "access")
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Access Management</h5>

                    @if (inventory.HasWriteAccess)
                    {
                        <div class="mb-4">
                            <label class="form-label">Grant Access</label>
                            <div class="input-group">
                                <input type="text" class="form-control" @bind="newAccessEmail" placeholder="Enter email or username" />
                                <button class="btn btn-primary" @onclick="GrantAccess">Grant Access</button>
                            </div>
                        </div>

                        @if (accessList.Any())
                        {
                            <h6>Users with Access:</h6>
                            <div class="list-group">
                                @foreach (var access in accessList)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@access.Username</strong>
                                            <br />
                                            <small class="text-muted">@access.Email</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RevokeAccess(access.UserId)">
                                            Revoke
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No users have explicit access yet.</p>
                        }
                    }
                    else
                    {
                        <p class="text-muted">Only the creator can manage access.</p>
                    }
                </div>
            </div>
        }
        else if (activeTab == "customid")
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Custom ID Format</h5>
                    <p class="text-muted">Configure how item IDs are generated</p>
                    <div class="alert alert-info">
                        <strong>Example ID:</strong> COMP-2025-E74FA329-001
                    </div>
                    <p class="text-muted">Custom ID builder will be here. For now, IDs are auto-generated.</p>
                </div>
            </div>
        }
        else if (activeTab == "stats")
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Statistics</h5>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">@inventory.ItemCount</h3>
                                    <p class="mb-0">Total Items</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (stats != null && stats.FieldStats.Any())
                    {
                        <h6>Field Statistics:</h6>
                        @foreach (var fieldStat in stats.FieldStats)
                        {
                            <div class="mb-3">
                                <strong>@fieldStat.Key:</strong>
                                <pre>@System.Text.Json.JsonSerializer.Serialize(fieldStat.Value, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No statistics available yet. Add some items to see statistics.</p>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private bool isLoading = true;
    private bool isAuthenticated = false;
    private string activeTab = "items";
    private string newAccessEmail = "";

    private InventoryResponseDto? inventory;
    private List<ItemResponseDto> items = new();
    private List<AccessDto> accessList = new();
    private StatsDto? stats;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthState.IsAuthenticatedAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            // Load inventory
            inventory = await Http.GetFromJsonAsync<InventoryResponseDto>($"/api/inventory/{Id}");

            // Load items
            items = await Http.GetFromJsonAsync<List<ItemResponseDto>>($"/api/item/inventory/{Id}") ?? new();

            // Load access list if has permission
            if (inventory?.HasWriteAccess == true)
            {
                accessList = await Http.GetFromJsonAsync<List<AccessDto>>($"/api/inventory/{Id}/access") ?? new();
            }

            // Load stats
            stats = await Http.GetFromJsonAsync<StatsDto>($"/api/inventory/{Id}/stats");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading inventory: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private async Task DeleteInventory()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this inventory?"))
            return;

        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.DeleteAsync($"/api/inventory/{Id}");
            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/dashboard");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting inventory: {ex.Message}");
        }
    }

    private async Task DeleteItem(int itemId)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this item?"))
            return;

        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.DeleteAsync($"/api/item/{itemId}");
            if (response.IsSuccessStatusCode)
            {
                items.RemoveAll(i => i.Id == itemId);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting item: {ex.Message}");
        }
    }

    private async Task ToggleLike(int itemId)
    {
        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var item = items.FirstOrDefault(i => i.Id == itemId);
            if (item == null) return;

            HttpResponseMessage response;
            if (item.IsLikedByCurrentUser)
            {
                response = await Http.DeleteAsync($"/api/item/{itemId}/like");
                if (response.IsSuccessStatusCode)
                {
                    item.LikeCount--;
                    item.IsLikedByCurrentUser = false;
                }
            }
            else
            {
                response = await Http.PostAsync($"/api/item/{itemId}/like", null);
                if (response.IsSuccessStatusCode)
                {
                    item.LikeCount++;
                    item.IsLikedByCurrentUser = true;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling like: {ex.Message}");
        }
    }

    private async Task GrantAccess()
    {
        if (string.IsNullOrWhiteSpace(newAccessEmail))
            return;

        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.PostAsJsonAsync($"/api/inventory/{Id}/access", new { EmailOrUsername = newAccessEmail });
            if (response.IsSuccessStatusCode)
            {
                newAccessEmail = "";
                accessList = await Http.GetFromJsonAsync<List<AccessDto>>($"/api/inventory/{Id}/access") ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error granting access: {ex.Message}");
        }
    }

    private async Task RevokeAccess(int userId)
    {
        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.DeleteAsync($"/api/inventory/{Id}/access/{userId}");
            if (response.IsSuccessStatusCode)
            {
                accessList.RemoveAll(a => a.UserId == userId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error revoking access: {ex.Message}");
        }
    }

    private string GetItemFieldValue(ItemResponseDto item, CustomFieldDto field)
    {
        var fieldIndex = inventory!.CustomFields.IndexOf(field) + 1;
        var fieldType = field.FieldType.ToLower();

        return fieldType switch
        {
            "string" => GetPropertyValue(item, $"CustomString{fieldIndex}Value"),
            "text" => GetPropertyValue(item, $"CustomText{fieldIndex}Value"),
            "number" => GetPropertyValue(item, $"CustomNumber{fieldIndex}Value"),
            "link" => GetPropertyValue(item, $"CustomLink{fieldIndex}Value"),
            "bool" => GetPropertyValue(item, $"CustomBool{fieldIndex}Value"),
            _ => ""
        };
    }

    private string GetPropertyValue(object obj, string propertyName)
    {
        var prop = obj.GetType().GetProperty(propertyName);
        var value = prop?.GetValue(obj);
        return value?.ToString() ?? "";
    }

    private string MarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return "";

        // Simple markdown-like conversion (basic)
        return markdown
            .Replace("\n", "<br />")
            .Replace("**", "<strong>", StringComparison.OrdinalIgnoreCase).Replace("**", "</strong>", StringComparison.OrdinalIgnoreCase);
    }

    // DTOs
    public class InventoryResponseDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string? ImageUrl { get; set; }
        public string CreatorUsername { get; set; } = "";
        public string? CategoryName { get; set; }
        public bool IsPublic { get; set; }
        public List<string> Tags { get; set; } = new();
        public List<CustomFieldDto> CustomFields { get; set; } = new();
        public int ItemCount { get; set; }
        public bool HasWriteAccess { get; set; }
        public int Version { get; set; }
    }

    public class CustomFieldDto
    {
        public string FieldType { get; set; } = "";
        public string Name { get; set; } = "";
        public string? Description { get; set; }
        public bool ShowInTable { get; set; }
    }

    public class ItemResponseDto
    {
        public int Id { get; set; }
        public string CustomId { get; set; } = "";
        public string? CustomString1Value { get; set; }
        public string? CustomString2Value { get; set; }
        public string? CustomString3Value { get; set; }
        public string? CustomText1Value { get; set; }
        public string? CustomText2Value { get; set; }
        public string? CustomText3Value { get; set; }
        public decimal? CustomNumber1Value { get; set; }
        public decimal? CustomNumber2Value { get; set; }
        public decimal? CustomNumber3Value { get; set; }
        public string? CustomLink1Value { get; set; }
        public string? CustomLink2Value { get; set; }
        public string? CustomLink3Value { get; set; }
        public bool? CustomBool1Value { get; set; }
        public bool? CustomBool2Value { get; set; }
        public bool? CustomBool3Value { get; set; }
        public string CreatedByUsername { get; set; } = "";
        public int LikeCount { get; set; }
        public bool IsLikedByCurrentUser { get; set; }
        public int Version { get; set; }
    }

    public class AccessDto
    {
        public int UserId { get; set; }
        public string Username { get; set; } = "";
        public string Email { get; set; } = "";
    }

    public class StatsDto
    {
        public int TotalItems { get; set; }
        public Dictionary<string, object> FieldStats { get; set; } = new();
    }
}