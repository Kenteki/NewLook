@page "/inventories/{InventoryId:int}/items/create"
@page "/inventories/{InventoryId:int}/items/{ItemId:int}"
@inject HttpClient Http
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>@(IsEditMode ? "Edit" : "Add") Item - NewLook</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            }
            else if (inventory == null)
            {
                <div class="alert alert-danger">Inventory not found</div>
            }
            else
            {
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">@(IsEditMode ? "Edit" : "Add") Item to @inventory.Title</h4>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                            <!-- Custom ID -->
                            <div class="mb-4">
                                <h5>Item ID</h5>
                                <hr />
                                <div class="mb-3">
                                    <label class="form-label">Custom ID</label>
                                    <InputText class="form-control" @bind-Value="model.CustomId" placeholder="Leave empty for auto-generation" />
                                    <small class="text-muted">Unique identifier for this item</small>
                                </div>
                            </div>

                            <!-- Dynamic Fields based on inventory configuration -->
                            @if (inventory.CustomFields.Any())
                            {
                                <div class="mb-4">
                                    <h5>Item Details</h5>
                                    <hr />

                                    @{
                                        int stringIndex = 1, textIndex = 1, numberIndex = 1, linkIndex = 1, boolIndex = 1;
                                    }

                                    @foreach (var field in inventory.CustomFields)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">
                                                @field.Name
                                                @if (!string.IsNullOrEmpty(field.Description))
                                                {
                                                    <small class="text-muted">(@field.Description)</small>
                                                }
                                            </label>

                                            @{
                                                var currentIndex = field.FieldType.ToLower() switch
                                                {
                                                    "string" => stringIndex++,
                                                    "text" => textIndex++,
                                                    "number" => numberIndex++,
                                                    "link" => linkIndex++,
                                                    "bool" => boolIndex++,
                                                    _ => 0
                                                };
                                            }

                                            @switch (field.FieldType.ToLower())
                                            {
                                                case "string":
                                                    if (currentIndex == 1)
                                                    {
                                                        <InputText class="form-control" @bind-Value="model.CustomString1Value" />
                                                    }
                                                    else if (currentIndex == 2)
                                                    {
                                                        <InputText class="form-control" @bind-Value="model.CustomString2Value" />
                                                    }
                                                    else if (currentIndex == 3)
                                                    {
                                                        <InputText class="form-control" @bind-Value="model.CustomString3Value" />
                                                    }
                                                    break;

                                                case "text":
                                                    if (currentIndex == 1)
                                                    {
                                                        <InputTextArea class="form-control" rows="3" @bind-Value="model.CustomText1Value" />
                                                    }
                                                    else if (currentIndex == 2)
                                                    {
                                                        <InputTextArea class="form-control" rows="3" @bind-Value="model.CustomText2Value" />
                                                    }
                                                    else if (currentIndex == 3)
                                                    {
                                                        <InputTextArea class="form-control" rows="3" @bind-Value="model.CustomText3Value" />
                                                    }
                                                    break;

                                                case "number":
                                                    if (currentIndex == 1)
                                                    {
                                                        <InputNumber class="form-control" @bind-Value="model.CustomNumber1Value" TValue="decimal?" />
                                                    }
                                                    else if (currentIndex == 2)
                                                    {
                                                        <InputNumber class="form-control" @bind-Value="model.CustomNumber2Value" TValue="decimal?" />
                                                    }
                                                    else if (currentIndex == 3)
                                                    {
                                                        <InputNumber class="form-control" @bind-Value="model.CustomNumber3Value" TValue="decimal?" />
                                                    }
                                                    break;

                                                case "link":
                                                    if (currentIndex == 1)
                                                    {
                                                        <InputText class="form-control" type="url" @bind-Value="model.CustomLink1Value" placeholder="https://example.com" />
                                                    }
                                                    else if (currentIndex == 2)
                                                    {
                                                        <InputText class="form-control" type="url" @bind-Value="model.CustomLink2Value" placeholder="https://example.com" />
                                                    }
                                                    else if (currentIndex == 3)
                                                    {
                                                        <InputText class="form-control" type="url" @bind-Value="model.CustomLink3Value" placeholder="https://example.com" />
                                                    }
                                                    break;

                                                case "bool":
                                                    if (currentIndex == 1)
                                                    {
                                                        <div class="form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="model.CustomBool1Value" TValue="bool?" />
                                                            <label class="form-check-label">@field.Name</label>
                                                        </div>
                                                    }
                                                    else if (currentIndex == 2)
                                                    {
                                                        <div class="form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="model.CustomBool2Value" TValue="bool?" />
                                                            <label class="form-check-label">@field.Name</label>
                                                        </div>
                                                    }
                                                    else if (currentIndex == 3)
                                                    {
                                                        <div class="form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="model.CustomBool3Value" TValue="bool?" />
                                                            <label class="form-check-label">@field.Name</label>
                                                        </div>
                                                    }
                                                    break;
                                            }
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Actions -->
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">Cancel</button>
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    @(IsEditMode ? "Update" : "Create") Item
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int InventoryId { get; set; }

    [Parameter]
    public int? ItemId { get; set; }

    private bool IsEditMode => ItemId.HasValue;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = "";

    private InventoryDto? inventory;
    private ItemDto model = new();

    protected override async Task OnInitializedAsync()
    {
        var isAuth = await AuthState.IsAuthenticatedAsync();
        if (!isAuth)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            // Load inventory
            inventory = await Http.GetFromJsonAsync<InventoryDto>($"/api/inventory/{InventoryId}");

            // Load item if editing
            if (IsEditMode && ItemId.HasValue)
            {
                var item = await Http.GetFromJsonAsync<ItemDto>($"/api/item/{ItemId.Value}");
                if (item != null)
                {
                    model = item;
                }
            }
            else
            {
                model.InventoryId = InventoryId;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = "";
        isSaving = true;

        try
        {
            var token = await AuthState.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            HttpResponseMessage response;
            if (IsEditMode && ItemId.HasValue)
            {
                response = await Http.PutAsJsonAsync($"/api/item/{ItemId.Value}", model);
            }
            else
            {
                response = await Http.PostAsJsonAsync("/api/item", model);
            }

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo($"/inventories/{InventoryId}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo($"/inventories/{InventoryId}");
    }

    // DTOs
    public class InventoryDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public List<CustomFieldDto> CustomFields { get; set; } = new();
    }

    public class CustomFieldDto
    {
        public string FieldType { get; set; } = "";
        public string Name { get; set; } = "";
        public string? Description { get; set; }
    }

    public class ItemDto
    {
        public int Id { get; set; }
        public int InventoryId { get; set; }
        public string? CustomId { get; set; }
        public string? CustomString1Value { get; set; }
        public string? CustomString2Value { get; set; }
        public string? CustomString3Value { get; set; }
        public string? CustomText1Value { get; set; }
        public string? CustomText2Value { get; set; }
        public string? CustomText3Value { get; set; }
        public decimal? CustomNumber1Value { get; set; }
        public decimal? CustomNumber2Value { get; set; }
        public decimal? CustomNumber3Value { get; set; }
        public string? CustomLink1Value { get; set; }
        public string? CustomLink2Value { get; set; }
        public string? CustomLink3Value { get; set; }
        public bool CustomBool1Value { get; set; }
        public bool CustomBool2Value { get; set; }
        public bool CustomBool3Value { get; set; }
        public int Version { get; set; }
    }
}