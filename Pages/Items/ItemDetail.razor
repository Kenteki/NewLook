@page "/items/{ItemId:int}"
@using NewLook.Services.Interfaces
@using NewLook.Models.DTOs.Item
@using NewLook.Models.DTOs.Inventory
@using Microsoft.AspNetCore.Components.Authorization
@inject IItemService ItemService
@inject IInventoryService InventoryService
@inject CustomAuthenticationStateProvider AuthState
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Item Details - NewLook</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading item details...</p>
        </div>
    }
    else if (item == null)
    {
        <div class="alert alert-danger">Item not found</div>
    }
    else
    {
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/inventories/@item.InventoryId">@inventoryTitle</a></li>
                <li class="breadcrumb-item active" aria-current="page">Item @item.CustomId</li>
            </ol>
        </nav>

        <!-- Item Header -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h2 class="mb-1">Item @item.CustomId</h2>
                        <small class="text-muted">Created by @item.CreatedByUsername on @item.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</small>
                    </div>
                    <div>
                        @if (isAuthenticated)
                        {
                            <button class="btn @(item.IsLikedByCurrentUser ? "btn-danger" : "btn-outline-danger") me-2" @onclick="ToggleLike">
                                <i class="bi bi-heart@(item.IsLikedByCurrentUser ? "-fill" : "")"></i> @item.LikeCount
                            </button>
                        }
                        else
                        {
                            <span class="badge bg-secondary">
                                <i class="bi bi-heart"></i> @item.LikeCount
                            </span>
                        }

                        @if (hasWriteAccess)
                        {
                            <a href="/inventories/@item.InventoryId/items/@ItemId/edit" class="btn btn-outline-primary me-2">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <button class="btn btn-outline-danger" @onclick="DeleteItem">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Details -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Item Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Custom ID:</dt>
                            <dd class="col-sm-8"><span class="badge bg-primary">@item.CustomId</span></dd>

                            <dt class="col-sm-4">Inventory:</dt>
                            <dd class="col-sm-8">
                                <a href="/inventories/@item.InventoryId">@inventoryTitle</a>
                            </dd>

                            <dt class="col-sm-4">Created At:</dt>
                            <dd class="col-sm-8">@item.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</dd>

                            <dt class="col-sm-4">Updated At:</dt>
                            <dd class="col-sm-8">@item.UpdatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</dd>
                        </dl>
                    </div>

                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Created By:</dt>
                            <dd class="col-sm-8">@item.CreatedByUsername</dd>

                            <dt class="col-sm-4">Likes:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-danger">
                                    <i class="bi bi-heart-fill"></i> @item.LikeCount
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>

                @if (customFields.Any())
                {
                    <hr />
                    <h6 class="mb-3">Custom Fields</h6>
                    <div class="row">
                        @foreach (var field in customFields)
                        {
                            var value = GetFieldValue(field);
                            if (!string.IsNullOrEmpty(value))
                            {
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">@field.Name</label>
                                    @if (field.FieldType.ToLower() == "text")
                                    {
                                        <div class="border rounded p-2 bg-light">
                                            <pre class="mb-0 pre-wrap">@value</pre>
                                        </div>
                                    }
                                    else if (field.FieldType.ToLower() == "link")
                                    {
                                        <div>
                                            <a href="@value" target="_blank" class="text-break">@value</a>
                                        </div>
                                    }
                                    else if (field.FieldType.ToLower() == "bool")
                                    {
                                        <div>
                                            @if (value.ToLower() == "true")
                                            {
                                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Yes</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary"><i class="bi bi-x-circle"></i> No</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="mb-0">@value</p>
                                    }
                                    @if (!string.IsNullOrEmpty(field.Description))
                                    {
                                        <small class="text-muted">@field.Description</small>
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int ItemId { get; set; }

    private bool isLoading = true;
    private bool isAuthenticated = false;
    private bool hasWriteAccess = false;
    private ItemResponseDto? item;
    private List<CustomFieldDto> customFields = new();
    private string inventoryTitle = "";

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthState.IsAuthenticatedAsync();
        await LoadItem();
    }

    private async Task LoadItem()
    {
        isLoading = true;
        try
        {
            var userId = await GetCurrentUserIdAsync();
            item = await ItemService.GetItemByIdAsync(ItemId, userId);

            if (item != null)
            {
                // Load inventory details
                var inventory = await InventoryService.GetInventoryByIdAsync(item.InventoryId, userId);
                if (inventory != null)
                {
                    inventoryTitle = inventory.Title;
                    customFields = inventory.CustomFields;
                    hasWriteAccess = inventory.HasWriteAccess;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading item: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<int?> GetCurrentUserIdAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        return userIdClaim != null ? int.Parse(userIdClaim.Value) : (int?)null;
    }

    private async Task ToggleLike()
    {
        if (!isAuthenticated || item == null)
            return;

        try
        {
            var userId = await GetCurrentUserIdAsync();
            if (!userId.HasValue) return;

            if (item.IsLikedByCurrentUser)
            {
                var (success, message) = await ItemService.UnlikeItemAsync(ItemId, userId.Value);
                if (success)
                {
                    item.IsLikedByCurrentUser = false;
                    item.LikeCount--;
                    StateHasChanged();
                }
            }
            else
            {
                var (success, message) = await ItemService.LikeItemAsync(ItemId, userId.Value);
                if (success)
                {
                    item.IsLikedByCurrentUser = true;
                    item.LikeCount++;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling like: {ex.Message}");
        }
    }

    private async Task DeleteItem()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this item?"))
            return;

        try
        {
            var userId = await GetCurrentUserIdAsync();
            if (!userId.HasValue) return;

            var (success, message) = await ItemService.DeleteItemAsync(ItemId, userId.Value);
            if (success)
            {
                Navigation.NavigateTo($"/inventories/{item!.InventoryId}");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error: {message}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error deleting item: {ex.Message}");
        }
    }

    private string GetFieldValue(CustomFieldDto field)
    {
        if (item == null) return "";

        var fieldIndex = customFields.IndexOf(field) + 1;
        var fieldType = field.FieldType.ToLower();

        return fieldType switch
        {
            "string" => GetPropertyValue(item, $"CustomString{fieldIndex}Value"),
            "text" => GetPropertyValue(item, $"CustomText{fieldIndex}Value"),
            "number" => GetPropertyValue(item, $"CustomNumber{fieldIndex}Value"),
            "link" => GetPropertyValue(item, $"CustomLink{fieldIndex}Value"),
            "bool" => GetPropertyValue(item, $"CustomBool{fieldIndex}Value"),
            _ => ""
        };
    }

    private string GetPropertyValue(object obj, string propertyName)
    {
        var prop = obj.GetType().GetProperty(propertyName);
        var value = prop?.GetValue(obj);
        return value?.ToString() ?? "";
    }
}
